# ==================== BEACON MACROS ====================
# ==================== macros/beacon.cfg ====================
# Beacon macros for testing accuracy and applying material offset

[gcode_macro BEACON_ACCURACY_TEST]
description: Run probe accuracy test with current Beacon setup
gcode:
    {% set samples = params.SAMPLES|default(10)|int %}
    _LOG_STATUS MSG="Running Beacon accuracy test ({samples} samples)" LED=busy
    PROBE_ACCURACY SAMPLES={samples} PROBE_METHOD=proximity
    _LOG_STATUS MSG="Beacon accuracy test completed" LED=ready

[gcode_macro BEACON_CONTACT_ACCURACY_TEST]
description: Run contact probe accuracy test
gcode:
    {% set samples = params.SAMPLES|default(10)|int %}
    _LOG_STATUS MSG="Running Beacon contact accuracy test ({samples} samples)" LED=busy
    PROBE_ACCURACY SAMPLES={samples} PROBE_METHOD=contact
    _LOG_STATUS MSG="Beacon contact accuracy test completed" LED=ready

[gcode_macro _APPLY_BEACON_MATERIAL_OFFSET]
description: Apply material-specific Z offset to Beacon model
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set offsets = printer['gcode_macro _global_var'].beacon_material_offsets %}
    {% set offset = offsets[material]|default(0.0)|float %}
    
    {% if offset != 0.0 %}
        _LOG_STATUS MSG="Applying {material} offset: {offset}mm to Beacon model" LED=busy
        SET_GCODE_OFFSET Z={offset}
        Z_OFFSET_APPLY_PROBE
        SET_GCODE_OFFSET Z=0
        _LOG_STATUS MSG="Beacon model updated with {material} offset" LED=ready
    {% else %}
        _LOG_STATUS MSG="No offset required for {material}" LED=ready
    {% endif %}

[gcode_macro FAST_QGL]
gcode:
    M117 QUAD_GANTRY_LEVEL
    {% if printer.configfile.settings.quad_gantry_level %}
        {% if printer.quad_gantry_level.applied == False %}
            QUAD_GANTRY_LEVEL RETRY_TOLERANCE=1
        {% endif %}
        QUAD_GANTRY_LEVEL horizontal_move_z=2
    {% endif %} 

[gcode_macro FAST_Z_TILT]
gcode:
    M117 Z_TILT
    {% if printer.configfile.settings.z_tilt %}
        {% if printer.z_tilt.applied == False %}
            Z_TILT_ADJUST RETRY_TOLERANCE=1
        {% endif %}
        Z_TILT_ADJUST horizontal_move_z=2
    {% endif %} 
